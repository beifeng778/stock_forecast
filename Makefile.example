# 生产环境配置
PROD_HOST ?= root@your-server-ip
PROD_PORT ?= 22
NGINX_DIR ?= /var/www/dist
REMOTE_DIR ?= /opt/stock-forecast
REMOTE_DATA_DIR ?= /opt/stock-forecast/data

REGISTRY ?= localhost:5000

# 镜像配置
VERSION ?= 1.0.0

.PHONY: help build-frontend deploy-frontend build-images push-images build-sample-gen push-sample-gen deploy-backend deploy-sample-gen deploy-db start-remote start-remote-sample-gen

help:
	@echo "Usage:"
	@echo "  make build-frontend    - Build frontend"
	@echo "  make deploy-frontend   - Deploy frontend to production"
	@echo "  make build-images      - Build Docker images"
	@echo "  make push-images       - Push images to server and load"
	@echo "  make build-sample-gen  - Build sample-gen Docker image"
	@echo "  make push-sample-gen   - Push sample-gen image to server and load"
	@echo "  make deploy-db         - Deploy database (Redis)"
	@echo "  make start-remote      - Start remote services"
	@echo "  make start-remote-sample-gen - Restart remote sample-gen only"
	@echo "  make deploy-backend    - Full backend deployment"
	@echo "  make deploy-sample-gen - Deploy sample-gen only"

# Build frontend
build-frontend:
	cd frontend && npm install && npx vite build

# Deploy frontend to production
deploy-frontend: build-frontend
	@echo "Packaging frontend files..."
	cd frontend && tar -czf ../frontend.tar.gz -C dist .
	@echo "Uploading to server..."
	scp frontend.tar.gz $(PROD_HOST):$(REMOTE_DIR)/
	@echo "Extracting and deploying..."
	ssh $(PROD_HOST) "rm -rf $(NGINX_DIR)_bak && mv $(NGINX_DIR) $(NGINX_DIR)_bak 2>/dev/null || true && mkdir -p $(NGINX_DIR) && tar -xzf $(REMOTE_DIR)/frontend.tar.gz -C $(NGINX_DIR) && rm -f $(REMOTE_DIR)/frontend.tar.gz && nginx -s reload"
	@echo "Cleaning up local tar..."
	rm -f frontend.tar.gz
	@echo "Frontend deployment completed"

# Build Docker images
build-images:
	docker build -t $(REGISTRY)/stock-forecast-backend:$(VERSION) ./backend

# Build sample-gen Docker image
build-sample-gen:
	docker build -t $(REGISTRY)/stock-forecast-sample-gen:$(VERSION) -f sample-gen/Dockerfile .

# Push images to server
push-images:
	@echo "Exporting image to tar..."
	docker save -o backend.tar $(REGISTRY)/stock-forecast-backend:$(VERSION)
	@echo "Uploading image to server..."
	scp backend.tar $(PROD_HOST):$(REMOTE_DIR)/
	@echo "Loading image on server..."
	ssh $(PROD_HOST) "cd $(REMOTE_DIR) && docker load -i backend.tar && rm -f backend.tar"
	@echo "Cleaning up local tar..."
	rm -f backend.tar
	@echo "Image upload completed"

# Push sample-gen image to server
push-sample-gen:
	@echo "Exporting image to tar..."
	docker save -o sample-gen.tar $(REGISTRY)/stock-forecast-sample-gen:$(VERSION)
	@echo "Uploading image to server..."
	scp sample-gen.tar $(PROD_HOST):$(REMOTE_DIR)/
	@echo "Loading image on server..."
	ssh $(PROD_HOST) "cd $(REMOTE_DIR) && docker load -i sample-gen.tar && rm -f sample-gen.tar"
	@echo "Cleaning up local tar..."
	rm -f sample-gen.tar
	@echo "Image upload completed"

# Start remote services
start-remote:
	scp compose/docker-compose.yml $(PROD_HOST):$(REMOTE_DIR)/
	ssh $(PROD_HOST) "mkdir -p $(REMOTE_DIR)/backend"
	scp backend/.env $(PROD_HOST):$(REMOTE_DIR)/backend/
	@echo "Uploading holidays.json..."
	scp backend/holidays.json $(PROD_HOST):$(REMOTE_DIR)/backend/
	ssh $(PROD_HOST) "cd $(REMOTE_DIR) && docker-compose up -d --force-recreate backend"

# Start remote sample-gen only
start-remote-sample-gen:
	scp compose/docker-compose.yml $(PROD_HOST):$(REMOTE_DIR)/
	ssh $(PROD_HOST) "mkdir -p $(REMOTE_DIR)/sample-gen"
	scp sample-gen/.env $(PROD_HOST):$(REMOTE_DIR)/sample-gen/
	ssh $(PROD_HOST) "cd $(REMOTE_DIR) && docker-compose up -d --force-recreate sample-gen"

# Deploy database (Redis)
deploy-db:
	@echo "Uploading DB compose file..."
	scp compose/docker-compose.db.yml $(PROD_HOST):$(REMOTE_DATA_DIR)/
	@echo "Starting DB container..."
	ssh $(PROD_HOST) "cd $(REMOTE_DATA_DIR) && docker-compose -f docker-compose.db.yml up -d --force-recreate"
	@echo "DB deployment completed"

# Full backend deployment
deploy-backend: build-images push-images start-remote
	@echo "Backend deployment completed"

# Deploy sample-gen only
deploy-sample-gen: build-sample-gen push-sample-gen start-remote-sample-gen
	@echo "sample-gen deployment completed"
