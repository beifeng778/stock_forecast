# 生产环境配置
PROD_HOST ?= root@your-server-ip
PROD_PORT ?= 22
NGINX_DIR ?= /var/www/dist
REMOTE_DIR ?= /opt/stock-forecast
REMOTE_DATA_DIR ?= /opt/stock-forecast/data

REGISTRY ?= localhost:5000

# 镜像配置
VERSION ?= 1.0.0

.PHONY: help build-frontend deploy-frontend build-images push-images build-sample-gen push-sample-gen deploy deploy-db start-remote

help:
	@echo "使用方法:"
	@echo "  make build-frontend    - 构建前端"
	@echo "  make deploy-frontend   - 部署前端到生产环境"
	@echo "  make build-images      - 构建Docker镜像"
	@echo "  make push-images       - 上传镜像到服务器并加载"
	@echo "  make build-sample-gen  - 构建 sample-gen 镜像"
	@echo "  make push-sample-gen   - 上传 sample-gen 镜像到服务器并加载"
	@echo "  make deploy-db         - 部署数据库(Redis)"
	@echo "  make start-remote      - 远程启动服务"
	@echo "  make deploy            - 完整部署流程"

# 构建前端
build-frontend:
	cd frontend && npm install && npx vite build

# 部署前端到生产环境
deploy-frontend: build-frontend
	@echo "打包前端文件..."
	cd frontend && tar -czf ../frontend.tar.gz -C dist .
	@echo "上传到服务器..."
	scp frontend.tar.gz $(PROD_HOST):$(REMOTE_DIR)/
	@echo "解压并部署..."
	ssh $(PROD_HOST) "rm -rf $(NGINX_DIR)_bak && mv $(NGINX_DIR) $(NGINX_DIR)_bak 2>/dev/null || true && mkdir -p $(NGINX_DIR) && tar -xzf $(REMOTE_DIR)/frontend.tar.gz -C $(NGINX_DIR) && rm -f $(REMOTE_DIR)/frontend.tar.gz && nginx -s reload"
	@echo "清理本地tar包..."
	rm -f frontend.tar.gz
	@echo "前端部署完成"

# 构建Docker镜像
build-images:
	docker build -t $(REGISTRY)/stock-forecast-backend:$(VERSION) ./backend

# 构建 sample-gen 镜像
build-sample-gen:
	docker build -t $(REGISTRY)/stock-forecast-sample-gen:$(VERSION) ./sample-gen

# 推送镜像到服务器
push-images:
	@echo "导出镜像为tar包..."
	docker save -o backend.tar $(REGISTRY)/stock-forecast-backend:$(VERSION)
	@echo "上传镜像到服务器..."
	scp backend.tar $(PROD_HOST):$(REMOTE_DIR)/
	@echo "在服务器加载镜像..."
	ssh $(PROD_HOST) "cd $(REMOTE_DIR) && docker load -i backend.tar && rm -f backend.tar"
	@echo "清理本地tar包..."
	rm -f backend.tar
	@echo "镜像上传完成"

# 推送 sample-gen 镜像到服务器
push-sample-gen:
	@echo "导出镜像为tar包..."
	docker save -o sample-gen.tar $(REGISTRY)/stock-forecast-sample-gen:$(VERSION)
	@echo "上传镜像到服务器..."
	scp sample-gen.tar $(PROD_HOST):$(REMOTE_DIR)/
	@echo "在服务器加载镜像..."
	ssh $(PROD_HOST) "cd $(REMOTE_DIR) && docker load -i sample-gen.tar && rm -f sample-gen.tar"
	@echo "清理本地tar包..."
	rm -f sample-gen.tar
	@echo "镜像上传完成"

# 远程启动服务
start-remote:
	scp compose/docker-compose.yml backend/.env $(PROD_HOST):$(REMOTE_DIR)/
	ssh $(PROD_HOST) "cd $(REMOTE_DIR) && docker-compose up -d --force-recreate"

# 部署数据库(Redis)
deploy-db:
	@echo "Uploading DB compose file..."
	scp compose/docker-compose.db.yml $(PROD_HOST):$(REMOTE_DATA_DIR)/
	@echo "Starting DB container..."
	ssh $(PROD_HOST) "cd $(REMOTE_DATA_DIR) && docker-compose -f docker-compose.db.yml up -d --force-recreate"
	@echo "DB deployment completed"

# 完整部署
deploy: deploy-frontend deploy-db build-images push-images start-remote
	@echo "部署完成"
